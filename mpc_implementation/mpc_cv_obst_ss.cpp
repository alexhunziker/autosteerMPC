#include <dlib/control.h>
#include <math.h>

using namespace dlib;

const int NR_OF_STATES = 7;
const int NR_OF_CONTROLS = 4;

matrix<double, NR_OF_STATES, NR_OF_STATES> ss_A[3];
matrix<double, NR_OF_STATES, NR_OF_CONTROLS> ss_B[3];

/* 
STATE: 
    Offset Y
    Yaw angle
    Yaw rate
    Side slip
    Dummy: target yaw
    Velocity
    Time to Collision

CONTROLS:
    Steering Angle
    Dummy: target yaw
    Throttle
    Breaks

Linearization for sample time 0.1s

Corresponding MATLAB/SIMULINK Model: mpc_cv_obst
*/

void init_ss()
{
    // Vx = 2.0
    matrix<double, NR_OF_STATES, NR_OF_STATES> A0;

    A0 = 1.01005016708417, 0, -0.0104962909812118, -0.000281775108874406, 0.0200013300514682, 0, 0,
    0, 1, 0.00521573236775262, 0.000140339553996367, 0, 0, 0,
    0, 0, 0.227356975419193, 0.0199799069155128, 0, 0, 0,
    0, 0, 0.00517705168705985, 0.597114155981437, 0, 0, 0,
    0, 0, 0, 0, 0.990148843682957, 0, 0,
    0, 0, 0, 0, 0, 0.999000499833375, 0,
    0, 0, 0, 0, 0, -0.00499750083312504, 1;
    ss_A[0] = A0;

    // Vx = 3.0
    matrix<double, NR_OF_STATES, NR_OF_STATES> A1;
    A1 = 1.01005016708417, 0, -0.0191733754866623, -0.000514532740517412, 0.0300019950772024, 0, 0,
    0, 1, 0.00635407624128044, 0.000170875858572245, 0, 0, 0,
    0, 0, 0.372527572610506, 0.0272839100291894, 0, 0, 0,
    0, 0, 0.00604646651292033, 0.709146479787837, 0, 0, 0,
    0, 0, 0, 0, 0.990148843682957, 0, 0,
    0, 0, 0, 0, 0, 0.999000499833375, 0,
    0, 0, 0, 0, 0, -0.00333166722208336, 1;
    ss_A[1] = A1;

    // Vx = 4.0
    matrix<double, NR_OF_STATES, NR_OF_STATES> A2;
    A2 = 1.01005016708417, 0, -0.0284149566941614, -0.000759696140622668, 0.0400006666700000, 0, 0,
    0, 1, 0.00706395910842331, 0.000189238551391244, 0, 0, 0,
    0, 0, 0.476860482790080, 0.0319842854081146, 0, 0, 0,
    0, 0, 0.00666833660091353, 0.772818297929357, 0, 0, 0,
    0, 0, 0, 0, 0.990049833749168, 0, 0,
    0, 0, 0, 0, 0, 0.999000499833375, 0,
    0, 0, 0, 0, 0, -0.00249875041656252, 1;
    ss_A[2] = A2;

    // Vx = 2.0
    matrix<double, NR_OF_STATES, NR_OF_CONTROLS> B0;
    B0 = -0.0107819560845690, -9.90041168678679e-05, 0, 0,
    0.00537103664061578, 0, 0, 0,
    0.866418146172481, 0, 0, 0,
    -0.153749086178215, 0, 0, 0,
    0, -0.00985115631704285, 0, 0,
    0, 0, 0.00999500166625009, -0.0199900033325002,
    0, 0, -2.49916687495834e-05, 4.99833374991668e-05;
    ss_B[0] = B0;

    // Vx = 3.0
    matrix<double, NR_OF_STATES, NR_OF_CONTROLS> B1;
    B1 = -0.0184984809501610, -0.000148506175301802, 0, 0,
    0.00614404692983220, 0, 0, 0,
    1.05668258153591, 0, 0, 0,
    -0.109083346303596, 0, 0, 0,
    0, -0.00985115631704285, 0, 0,
    0, 0, 0.00999500166625009, -0.0199900033325002,
    0, 0, -1.66611124997223e-05, 3.33222249994445e-05;
    ss_B[1] = B1;

    // Vx = 4.0
    matrix<double, NR_OF_STATES, NR_OF_CONTROLS> B2;
    B2 = -0.0264920008937277, -0.000200001666672222, 0, 0,
    0.00659964738959933, 0, 0, 0,
    1.17539112379496, 0, 0, 0,
    -0.0835780184612082, 0, 0, 0,
    0, -0.00995016625083195, 0, 0,
    0, 0, 0.00999500166625008, -0.0199900033325002,
    0, 0, -1.24958343747917e-05, 2.49916687495834e-05;
    ss_B[2] = B2;
}